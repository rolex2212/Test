const express=require('express'),axios=require('axios'),app=express(),PORT=process.env.PORT||3000,h={"User-Agent":"Mozilla/5.0 (QtEmbedded; U; Linux; C) AppleWebKit/533.3 (KHTML, like Gecko) MAG200 stbapp ver: 2 rev: 250 Safari/533.3","X-User-Agent":"Model: MAG250; Link: WiFi",Cookie:"mac=00:1A:79:17:1E:AA; stb_lang=en; timezone=GMT",Referer:"http://tv.maxx4k.cc/stalker_portal/c/",Accept:"*/*"};app.get('/proxy',async(req,res)=>{try{const u=Buffer.from(req.query.url,'base64').toString(),r=await axios.get(u,{headers:h,responseType:'stream'});res.setHeader('Content-Type','video/mp2t'),r.data.pipe(res)}catch(e){res.status(500).send("Proxy Error")}}),app.get('/master.m3u8',async(req,res)=>{try{const c=req.query.c;if(!c)return res.send("Add ?c=ChannelName");const s=await axios.get("http://tv.maxx4k.cc/stalker_portal/server/load.php?type=stb&action=handshake&JsHttpRequest=1-xml",{headers:h}),t=s.data.js.token,ah={...h,Authorization:`Bearer ${t}`};await axios.get("http://tv.maxx4k.cc/stalker_portal/server/load.php?type=stb&action=get_profile&stb_type=MAG250&sn=797995C29B984&device_id=797995c29b984c9b0f4cd869c93cd610&JsHttpRequest=1-xml",{headers:ah});const m=await axios.get("http://tv.maxx4k.cc/stalker_portal/server/load.php?type=itv&action=get_all_channels&JsHttpRequest=1-xml",{headers:ah}),f=m.data.js.data.find(i=>i.name.toLowerCase().replace(/[\s_]/g,'').includes(c.toLowerCase().replace(/[\s_]/g,'')));if(!f)return res.status(404).send("Not Found");const l=await axios.get(`http://tv.maxx4k.cc/stalker_portal/server/load.php?type=itv&action=create_link&cmd=${encodeURIComponent(f.cmds[0].url)}&JsHttpRequest=1-xml`,{headers:ah});let u=l.data.js.cmd;u.includes(' ')&&(u=u.split(' ').pop());const x=await axios.get(u,{headers:h}),b=u.substring(0,u.lastIndexOf('/')+1);let d=x.data;if(d.includes('.m3u8')){const n=d.split('\n').find(l=>l.trim()&&!l.startsWith('#')),nu=n.startsWith('http')?n:b+n.trim(),nx=await axios.get(nu,{headers:h});d=nx.data}const final=d.split('\n').map(l=>{if(l.trim()&&!l.startsWith('#')){const f=l.startsWith('http')?l:b+l.trim();return`http://${req.get('host')}/proxy?url=${Buffer.from(f).toString('base64')}`}return l}).join('\n');res.setHeader('Content-Type','application/vnd.apple.mpegurl'),res.send(final)}catch(e){res.status(500).send(e.message)}}
